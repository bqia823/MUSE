<link rel="stylesheet" href="/css/create_article.css">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="/client/createArticleCilent.js"></script>
<body>
    <nav class="navbar">
        <div class="navbar_logo">
            <img src="/images/logopng-after-trim.png" alt="Logo">
            <span>MUSE</span>
        </div>
           <ul class="navbar_functions">
            <li><a href="/"><span class="icon"><img src="/images/home.png" id="home_icon"></span>Home</a></li>
            {{#if hasUnreadNotifications}}
            <li id="notification"><a href="/notification/{{user.User_ID}}/1"><span class="icon"><img src="/images/notification-red.png" id="notification_icon"></span>Notifications</a>
            <div id="unReadComment">{{unReadComment}}</div>
            </li>
            {{else}}
            <li id="notification"><a href="/notification/{{user.User_ID}}"><span class="icon"><img src="/images/notification-pink.png" id="notification_icon"></span>Notifications</a></li>
            {{/if}}
            <li><a href="/profile/{{user.User_ID}}"><span class="icon"><img src="/images/{{user.Avatar}}" id="profile_icon"></span>My Profile</a></li>
            <li><a href="/logout"><span class="icon"><img src="/images/logout-box.png" id="create_article_icon"></span>Sign Out</a></li>
        </ul>
    </nav>
 <div id="icon-container">
      <div id="notificationTop">Notification</div><span><strong>Unread notification: {{unreadNotificationsCount.count}}</strong></span>
      <div id="notificationBottom">
        {{#each notifications}}
        <div class="notifications" id="notifications{{this.Notification_ID}}">
            <div class="firstLine">
              <div class="contentLine">{{this.Content}}</div>
            {{#unless this.Is_Read}}
            <div class="red-dot"></div>
            {{/unless}}
          </div>
          
        <!-- 头像，用户名，发布时间 -->
        <div class="senderInformation">{{this.Timestamp}}</div>
      </div>
      {{/each}}
      <div id="notificationMore">More</div>
    </div>
  </div>
    <form class="container" action="/editArticle/{{article.Article_ID}}" method="POST" enctype="multipart/form-data">
        <div class="input_group">
            <div class="sub_group">
                <span class="title_hint">Title:</span>
            </div>
            <div class="sub_group">
                <input class="title_text" type="text" name="title" value="{{article.Title}}">
            </div>
        </div>
        <div class="input_group">
            <div class="sub_group">
                <span class="content_hint" class="content_text">Content:</span>
            </div>
            <div class="sub_group" id="editor">{{{article.Content}}}</div>
            <input type="hidden" id="hiddenContent" name="content">
            </div>
        </div>
        <div class="input_group">
            <div class="sub_group">
                <div class="image-display">
                    <label class="image_hint" for="txtCaption">Your image:</label>
                    <img id="image" src="/uploadedFiles/{{article.Image}}">
                </div>
                <br>
                <div>
                    <span class="image_hint">Upload a new image in the following formats: .png, .jpg, .jpeg, .bmp:
                    </span>
                </div>
                <br>
                <div>
                    <input type="file" name="imageFile" accept=".png,.jpg,.jpeg,.bmp">
                    {{!-- <label for="txtCaption">Caption:</label>

                    <input id="txtCaption" type="text" name="caption"> --}}
                </div>
            </div>

            <div>
                <button class="edit_article_button">Publish Changes</button>
            </div>
        </div>

    </form>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js">
    </script>
    <script>
        const toolbarOptions = [
            ['bold', 'italic', 'underline'],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            [{ 'header': 1 }, { 'header': 2 }]
        ];
        const quill = new Quill('#editor', {
            modules: {
                toolbar: toolbarOptions
            },
            theme: 'snow'
        });

    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!--  JavaScript 代码 -->
    <script>
        const userID = '{{user.User_ID}}';
        $(document).ready(function () {
            // 检查图片 URL 是否为空
            const imageUrl = $('#image').attr('src');
            if (!imageUrl || imageUrl == '/uploadedFiles/') {
            // 如果图片 URL 为空，则隐藏显示图片的部分
            $('.image-display').hide();
            
        }
            $('form').on('submit', function (event) {
                const content = document.getElementById('editor').innerHTML;
                document.getElementById('hiddenContent').value = content;
                event.preventDefault(); // 阻止表单的默认提交事件
                $.ajax({
                    url: $(this).attr('action'), // 提交到表单的 action 属性指定的 URL
                    type: 'POST',
                    data: new FormData(this), // 创建一个 FormData 对象，包含表单的数据
                    processData: false, // 告诉 jQuery 不要处理发送的数据
                    contentType: false, // 告诉 jQuery 不要设置 Content-Type 请求头
                    success: function (data) {
                        // 请求成功的处理逻辑
                        // data 参数是服务器返回的响应
                        if (data.success) {
                        alert('You have successfully re-published the article!');
                         var currentURL = window.location.href;
                        const parsedUrl = new URL(currentURL);
                        const articleId = parsedUrl.pathname.split('/').pop();
                        window.location.href = '/articleView/' + articleId;
                        } else {
                            alert('You have failed to publish the article!');
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        // 请求失败的处理逻辑
                        alert('You have failed to publish the article!');
                    }
                });
            });
        });
        $(document).ready(function() {
  $('input[data-formula], a.ql-action, a.ql-remove').hide();
});
    </script>
    {{!--
    <script>
        fetch('/checkLoginStatus')
            .then(response => response.json())
            .then(data => {
                if (data.loggedIn) {
                    // 如果用户是登陆的状态，那么就加载页面
                } else {
                    //如果用户是没有登陆的状态，那么就跳转到登陆页面
                    window.location.href = '/login';
                }
            });

    </script> --}}


</body>